
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Role, Message, Product, CartItem, Citation } from './types';
import { getGeminiResponse } from './services/geminiService';

const RAW_PRODUCTS = `agnès b. $50 禮券,20081,42.5,10
agnès b. $80 禮券,200082,68,10
agnès b. $100 禮券,20083,85,10
聖安娜 $25 禮券,10127,17.5,10
聖安娜 $50 禮券,10209,35,10
GODIVA $50 (粉紅封套),10344,42.5,10
GODIVA $50 (深啡封套),10110,42.5,10
GODIVA 軟雪糕及飲品禮券,10116,50.2,10
GODIVA $100 禮券,SKU_G100,85,10
東海堂 $50 (花慶/經典版),10274,39.5,10
太興 $50 金豬禮券,10419,44,10
鴻福堂 $50 (囍/粉紅),10278,36,10
鴻福堂 自家湯套票 (10張),SKU_HFT_S,395,1
鴻福堂 自家涼茶套票 (10張),SKU_HFT_T,395,1
Lady M US$80 禮券,10437,64,10
Lady M US$150 禮券,10430,120,10
L.M.D.C $50 禮券,10376,42,10
L.M.D.C $100 禮券,10380,85,5
L.M.D.C $500 禮券,10381,425,1
華御結 $25 禮券,10446,21.25,10
華御結 $50 禮券,10444,42.5,10
甜姨姨 $50 禮券 (紅色/淡黃),10270,35,10
永樂 嫁囍禮券,10420,46,10
LE CREUSET $100 禮券,10290,60,1
LE CREUSET $500 禮券,SKU_LC500,300,1
LE CREUSET $1000 禮券,10294,600,1
奇華 $50 禮券,10461,40,10
奇華 金盈喜禮券,10463,70,10
agnès b. 回禮圓筒禮盒,10370,39.1,50
Godiva 雅致巧克力鐵盒 (2顆),10135,50.2,100
Godiva 巧克力紙盒 (2顆),10131,33.2,100
Lady M 女王棉花餅,10388,23,50
糕點時光 囍糖雜錦,10402,17.6,100
永樂 有麵子回禮小禮物,10422,30,100`;

const App: React.FC = () => {
  const [products] = useState<Product[]>(() => 
    RAW_PRODUCTS.trim().split('\n').map(line => {
      const [name, sku, price, minQty] = line.split(',');
      return { 
        name, 
        sku, 
        price: parseFloat(price) || 0, 
        minQty: parseInt(minQty) || 1 
      };
    })
  );

  const [cart, setCart] = useState<Record<string, number>>({});
  const [searchTerm, setSearchTerm] = useState('');
  const [showCart, setShowCart] = useState(false);
  const [showQR, setShowQR] = useState(false);
  const [showAI, setShowAI] = useState(false);
  const [orderId, setOrderId] = useState('');
  
  const [messages, setMessages] = useState<Message[]>([
    { id: '1', role: Role.MODEL, content: "歡迎光臨 Bespoke Wedding！我現在可以存取即時網站資訊提供最新優惠。如有預算問題，我可以幫您計算最划算的方案！", timestamp: new Date() }
  ]);
  const [aiInput, setAiInput] = useState('');
  const [isAiLoading, setIsAiLoading] = useState(false);

  const qrCanvasRef = useRef<HTMLCanvasElement>(null);
  const aiEndRef = useRef<HTMLDivElement>(null);

  const filteredProducts = useMemo(() => 
    products.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase())),
    [products, searchTerm]
  );

  const cartItems = useMemo(() => 
    Object.entries(cart).reduce((acc: CartItem[], [sku, qty]) => {
      const p = products.find(prod => prod.sku === sku);
      if (p) {
        acc.push({ ...p, quantity: qty } as CartItem);
      }
      return acc;
    }, []),
    [cart, products]
  );

  const totalPrice = useMemo(() => 
    cartItems.reduce((acc: number, item: CartItem) => acc + (item.price * item.quantity), 0),
    [cartItems]
  );

  const totalCount = useMemo(() => 
    Object.values(cart).reduce((acc: number, qty: number) => acc + qty, 0),
    [cart]
  );

  useEffect(() => {
    if (aiEndRef.current) aiEndRef.current.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  const updateQty = (sku: string, delta: number) => {
    const product = products.find(p => p.sku === sku);
    if (!product) return;

    setCart(prev => {
      const current = prev[sku] || 0;
      let newVal = current + delta;
      
      if (current === 0 && delta > 0) newVal = product.minQty;
      else if (current === product.minQty && delta < 0) newVal = 0;
      else if (newVal > 0 && newVal < product.minQty) newVal = product.minQty;
      else newVal = Math.max(0, newVal);
      
      const next = { ...prev };
      if (newVal === 0) delete next[sku];
      else next[sku] = newVal;
      return next;
    });
  };

  const generateOrder = () => {
    if (totalCount === 0) return;
    const id = Math.floor(10000000 + Math.random() * 90000000).toString();
    setOrderId(id);
    setShowCart(false);
    setShowQR(true);

    setTimeout(() => {
      if (qrCanvasRef.current) {
        const qrData = `ORDER:${id}|TOTAL:${totalPrice}|ITEMS:${cartItems.map(i => `${i.sku}x${i.quantity}`).join(',')}`;
        // @ts-ignore
        new QRious({
          element: qrCanvasRef.current,
          value: qrData,
          size: 260,
          level: 'H'
        });
      }
    }, 100);
  };

  const handleAiSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!aiInput.trim() || isAiLoading) return;

    const userMsg: Message = { id: Date.now().toString(), role: Role.USER, content: aiInput, timestamp: new Date() };
    setMessages(prev => [...prev, userMsg]);
    setAiInput('');
    setIsAiLoading(true);

    try {
      const result = await getGeminiResponse(aiInput, messages);
      const modelMsg: Message = { 
        id: (Date.now() + 1).toString(), 
        role: Role.MODEL, 
        content: result.text, 
        timestamp: new Date(),
        citations: result.citations
      };
      setMessages(prev => [...prev, modelMsg]);
    } catch (err) {
      console.error(err);
    } finally {
      setIsAiLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex flex-col max-w-lg mx-auto bg-gray-50">
      {/* Header */}
      <header className="sticky top-0 z-40 bg-white border-b px-5 py-4 shadow-sm">
        <div className="flex justify-between items-center mb-3">
          <h1 className="text-2xl font-black text-rose-500 italic tracking-tighter">Bespoke Wedding</h1>
          <div className="flex gap-2">
            <a 
              href="https://bariumbw.github.io/item/" 
              target="_blank" 
              rel="noopener noreferrer"
              className="w-10 h-10 rounded-full bg-slate-100 text-slate-600 flex items-center justify-center shadow-sm"
              title="查看即時網站"
            >
              <i className="fas fa-external-link-alt"></i>
            </a>
            <button 
              onClick={() => setShowAI(!showAI)}
              className="w-10 h-10 rounded-full bg-rose-50 text-rose-500 flex items-center justify-center relative shadow-inner"
            >
              <i className="fas fa-magic"></i>
              {!showAI && <span className="absolute -top-1 -right-1 flex h-3 w-3"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-rose-400 opacity-75"></span><span className="relative inline-flex rounded-full h-3 w-3 bg-rose-500"></span></span>}
            </button>
          </div>
        </div>
        <div className="relative group">
          <i className="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-rose-400 transition-colors"></i>
          <input 
            type="text" 
            placeholder="搜尋禮券品牌或禮物..." 
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="w-full bg-gray-100 border-none rounded-2xl pl-11 pr-5 py-3.5 text-sm focus:ring-2 focus:ring-rose-200 outline-none transition-all"
          />
        </div>
      </header>

      {/* Main Product List */}
      <main className="flex-1 p-4 pb-32 space-y-4 overflow-y-auto">
        <div className="px-1 mb-2">
          <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
            <i className="fas fa-info-circle mr-1"></i> 所有優惠價均需符合最少購買量
          </p>
        </div>
        {filteredProducts.map(p => (
          <div key={p.sku} className="product-card bg-white p-4 rounded-3xl shadow-sm border border-gray-100 flex items-center justify-between">
            <div className="flex-1 pr-4">
              <div className="flex items-center gap-2 mb-1">
                <h4 className="text-sm font-bold text-slate-800 leading-snug">{p.name}</h4>
                <span className="bg-rose-50 text-rose-600 text-[9px] font-black px-2 py-0.5 rounded-full border border-rose-100">
                  Min: {p.minQty}
                </span>
              </div>
              <div className="flex items-center gap-2">
                <span className="text-rose-500 font-black text-lg">HK${p.price}</span>
              </div>
            </div>
            <div className="flex items-center space-x-3 bg-slate-50 p-1.5 rounded-full border border-slate-100">
              <button 
                onClick={() => updateQty(p.sku, -1)}
                className={`w-9 h-9 rounded-full flex items-center justify-center transition-all ${cart[p.sku] ? 'bg-white shadow-sm text-slate-400 hover:text-rose-500' : 'text-slate-200'}`}
              >
                <i className="fas fa-minus"></i>
              </button>
              <div className="flex flex-col items-center min-w-[24px]">
                <span className={`font-black text-sm ${cart[p.sku] ? 'text-slate-800' : 'text-slate-300'}`}>
                  {cart[p.sku] || 0}
                </span>
              </div>
              <button 
                onClick={() => updateQty(p.sku, 1)}
                className="w-9 h-9 rounded-full bg-rose-500 shadow-md text-white flex items-center justify-center hover:scale-105 active:scale-95 transition-all"
              >
                <i className="fas fa-plus"></i>
              </button>
            </div>
          </div>
        ))}
      </main>

      {/* Footer & Modals ... (保持原樣，僅展示 AI 部分更新) */}
      
      {/* AI Chat Drawer */}
      {showAI && (
        <div className="fixed inset-0 z-[70] flex items-end justify-center">
          <div className="absolute inset-0 bg-black/20" onClick={() => setShowAI(false)}></div>
          <div className="bg-white w-full max-w-md h-[85vh] rounded-t-[3rem] shadow-2xl flex flex-col relative z-10 animate-in slide-in-from-bottom duration-300">
            <div className="p-6 border-b flex justify-between items-center bg-rose-500 text-white rounded-t-[3rem]">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center"><i className="fas fa-sparkles"></i></div>
                <div>
                  <h3 className="font-bold text-lg leading-none">婚禮智能助手</h3>
                  <p className="text-[10px] opacity-70 mt-1 uppercase tracking-widest">Live Search Enabled</p>
                </div>
              </div>
              <button onClick={() => setShowAI(false)} className="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 transition-colors"><i className="fas fa-times"></i></button>
            </div>

            <div className="flex-1 overflow-y-auto p-6 space-y-6 hide-scrollbar bg-slate-50">
              {messages.map(m => (
                <div key={m.id} className={`flex flex-col ${m.role === Role.USER ? 'items-end' : 'items-start'}`}>
                  <div className={`max-w-[85%] px-5 py-4 rounded-3xl text-sm leading-relaxed shadow-sm ${
                    m.role === Role.USER 
                      ? 'bg-rose-500 text-white rounded-tr-none' 
                      : 'bg-white text-slate-700 border border-slate-100 rounded-tl-none'
                  }`}>
                    {m.content}
                  </div>
                  {/* 顯示搜尋來源標籤 */}
                  {m.citations && m.citations.length > 0 && (
                    <div className="mt-2 flex flex-wrap gap-2">
                      {m.citations.map((cite, idx) => (
                        <a 
                          key={idx} 
                          href={cite.uri} 
                          target="_blank" 
                          rel="noopener noreferrer"
                          className="flex items-center gap-1 bg-white border border-slate-200 text-rose-500 text-[10px] px-2 py-1 rounded-full hover:bg-rose-50 transition-colors shadow-sm"
                        >
                          <i className="fas fa-link text-[8px]"></i>
                          {cite.title.length > 15 ? cite.title.substring(0, 15) + '...' : cite.title}
                        </a>
                      ))}
                    </div>
                  )}
                </div>
              ))}
              {isAiLoading && (
                <div className="flex justify-start">
                  <div className="bg-white px-5 py-4 rounded-3xl rounded-tl-none border border-slate-100 shadow-sm flex gap-2">
                    <span className="w-1.5 h-1.5 bg-rose-300 rounded-full animate-bounce"></span>
                    <span className="w-1.5 h-1.5 bg-rose-300 rounded-full animate-bounce delay-75"></span>
                    <span className="w-1.5 h-1.5 bg-rose-300 rounded-full animate-bounce delay-150"></span>
                  </div>
                </div>
              )}
              <div ref={aiEndRef} />
            </div>

            <form onSubmit={handleAiSubmit} className="p-6 bg-white border-t flex gap-3 pb-8">
              <input 
                type="text" 
                placeholder="詢問最新優惠資訊..." 
                value={aiInput}
                onChange={(e) => setAiInput(e.target.value)}
                className="flex-1 bg-gray-100 border-none rounded-2xl px-5 py-4 text-sm focus:ring-2 focus:ring-rose-400 outline-none"
              />
              <button 
                type="submit"
                disabled={isAiLoading}
                className="w-14 h-14 rounded-2xl bg-rose-500 text-white flex items-center justify-center shadow-lg shadow-rose-200 active:scale-90 transition-all disabled:opacity-50"
              >
                <i className="fas fa-paper-plane"></i>
              </button>
            </form>
          </div>
        </div>
      )}

      {/* 餘下 Footer 邏輯保持原樣 */}
      {showCart && (
        <div className="fixed inset-0 bg-black/40 z-50 flex items-end sm:items-center justify-center p-0 sm:p-4 animate-in fade-in duration-200">
          <div className="bg-white w-full max-w-md rounded-t-[3rem] sm:rounded-[3rem] p-8 shadow-2xl transform transition-transform animate-in slide-in-from-bottom duration-300">
            <div className="flex justify-between items-center mb-6 border-b pb-6">
              <h3 className="text-xl font-black text-slate-800">確認訂單內容</h3>
              <button onClick={() => setShowCart(false)} className="w-10 h-10 rounded-full bg-gray-50 text-gray-400 flex items-center justify-center"><i className="fas fa-times"></i></button>
            </div>
            
            <div className="max-h-[50vh] overflow-y-auto mb-8 pr-2 hide-scrollbar divide-y divide-slate-50">
              {cartItems.map(item => (
                <div key={item.sku} className="py-4 flex justify-between items-center">
                  <div className="flex-1 pr-4">
                    <h5 className="text-sm font-bold text-slate-700 leading-tight">{item.name}</h5>
                    <p className="text-rose-500 text-xs font-bold mt-1">HK${item.price} × {item.quantity}</p>
                    <p className="text-[9px] text-slate-400 font-bold">Min: {item.minQty}pcs required</p>
                  </div>
                  <div className="flex items-center space-x-3">
                    <button onClick={() => updateQty(item.sku, -1)} className="w-7 h-7 rounded-full bg-gray-100 flex items-center justify-center text-xs"><i className="fas fa-minus"></i></button>
                    <span className="w-4 text-center font-black text-sm">{item.quantity}</span>
                    <button onClick={() => updateQty(item.sku, 1)} className="w-7 h-7 rounded-full bg-rose-500 text-white flex items-center justify-center text-xs shadow-md"><i className="fas fa-plus"></i></button>
                  </div>
                </div>
              ))}
            </div>

            <div className="flex justify-between items-center mb-8 px-2">
              <span className="font-bold text-slate-400 tracking-widest uppercase text-xs">應付總計</span>
              <span className="text-3xl font-black text-rose-600">HK$ {totalPrice.toLocaleString()}</span>
            </div>

            <button 
              onClick={generateOrder}
              className="w-full bg-rose-500 text-white py-5 rounded-2xl font-bold text-lg shadow-xl hover:shadow-rose-200 active:scale-[0.98] transition-all flex items-center justify-center gap-3"
            >
              <i className="fas fa-check-circle"></i>
              <span>確認訂單並生成二維碼</span>
            </button>
          </div>
        </div>
      )}

      {showQR && (
        <div className="fixed inset-0 bg-slate-900/95 z-[60] flex items-center justify-center p-6 backdrop-blur-sm animate-in zoom-in duration-300">
          <div className="bg-white w-full max-w-sm rounded-[3rem] p-10 text-center shadow-2xl overflow-hidden relative">
            <div className="absolute top-0 left-0 right-0 h-2 bg-rose-500"></div>
            <div className="mb-6">
               <div className="w-16 h-16 bg-rose-50 text-rose-500 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                 <i className="fas fa-qrcode"></i>
               </div>
               <h3 className="text-2xl font-black text-slate-800 mb-2">訂單已成功生成</h3>
               <p className="text-slate-400 text-xs uppercase tracking-widest font-bold">請向現場工作人員出示此碼</p>
            </div>
            
            <div className="bg-slate-50 p-6 rounded-[2.5rem] inline-block mb-8 border border-slate-100 shadow-inner">
              <canvas ref={qrCanvasRef} className="mx-auto rounded-xl"></canvas>
            </div>
            
            <div className="mb-10">
              <p className="text-slate-300 text-[10px] uppercase font-black tracking-[0.3em] mb-1">Order Ref No.</p>
              <p className="text-4xl font-black text-slate-900 tracking-[0.2em]">{orderId}</p>
              <p className="text-rose-500 font-bold mt-4 text-xl tracking-tight">Total: HK$ {totalPrice.toLocaleString()}</p>
            </div>
            
            <button 
              onClick={() => setShowQR(false)} 
              className="w-full py-5 text-slate-400 text-sm font-black active:bg-gray-50 rounded-2xl transition-colors tracking-widest uppercase"
            >
              <i className="fas fa-chevron-left mr-2"></i> 返回修改訂單
            </button>
          </div>
        </div>
      )}

      <footer className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-gray-100 p-5 z-40 max-w-lg mx-auto rounded-t-[2.5rem] shadow-2xl">
        <div className="flex justify-between items-center px-2">
          <div className="flex flex-col">
            <span className="text-gray-400 text-[10px] font-bold uppercase tracking-widest">應付總額 Total</span>
            <span className="text-2xl font-black text-slate-900 tracking-tight">HK$ {totalPrice.toLocaleString()}</span>
          </div>
          <button 
            onClick={() => totalCount > 0 && setShowCart(true)}
            className={`relative flex items-center gap-3 px-8 py-4 rounded-2xl font-bold transition-all ${totalCount > 0 ? 'bg-slate-900 text-white shadow-xl active:scale-95' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}`}
          >
            <span>預覽購物車</span>
            <span className={`flex items-center justify-center w-6 h-6 rounded-full text-[10px] border-2 border-white transition-all ${totalCount > 0 ? 'bg-rose-500 scale-110' : 'bg-gray-300'}`}>
              {totalCount}
            </span>
          </button>
        </div>
      </footer>
    </div>
  );
};

export default App;
